---
title: "MRM_prep"
author: "Lili Benitez"
date: "2024-09-17"
output: html_document
---
### load libraries 
```{r, warning=FALSE, include= FALSE}
library(tidyverse)
library(ggplot2)
library(CommEcol)
library(ecodist)
```

### Read in specimen and veg data
```{r}
load("../../Dropbox/skyIslands/data/spec_net.Rdata")

net_specimens<-spec.net%>%
  filter(Method=="Net")#filter by netted insects, actually all are netted I guess

veg<-read_csv("../../Dropbox/skyIslands_saved/data/relational/relational/traditional/veg-complete.csv")

sitestats<-read_csv("../../Dropbox/skyIslands/data/sitestats.csv") #NO LONGITUDE???

```
### Now I want to calculate chao dissimliarity for netted bee communities.
```{r, bee chao dissimilarity}
####bee dissimilarity####
bee<-net_specimens%>%
  filter(Order=="Hymenoptera")%>% #filter all hymenoptera, goes down to 10,783
  filter(!Family=="Sphecidae",!Family=="Braconidae",!Family=="Vespidae") #filter out wasps, goes down to 9,958 observations

bee<-bee%>%
  select(Site, GenusSpecies, Year, SampleRound, State, Meadow) #don't need all the other info
bee_n<-bee%>%
  group_by(Site, Year,SampleRound)%>%
  count(GenusSpecies)%>%
filter(!(Site=="CC"))%>%# CC is just a non-site site
  mutate(SiteYear=paste0(Site, Year))%>%
   filter(!(SiteYear=="PL2017")) #veg data was messed up here, plus there was only one sample round before fire
bee_all<-data.frame( plots = bee_n$SiteYear, species =bee_n$GenusSpecies,
                      freq = bee_n$n, stringsAsFactors=FALSE)
mean_bee<-crosstab(plots, species, freq, data=bee_all, type="mean")#average species frequencies
bee.dis<-dis.chao(mean_bee, index="jaccard", version='prob') #I think the probability version was better than the rare one for some reason? 
bee.dis<-as.matrix(bee.dis) #at the moment, all site/year combos, diagonal is all zeros which is good

#write.csv(net.bee.chao, "net.bee.prob.csv", row.names=FALSE)
```

### Now we are doing the same thing for the syrphids
```{r, syrph chao dissimilarity}
syrph<-net_specimens%>%
  filter(Order=="Diptera") #filter all syrphids, 2,565 observations
syrph<-syrph%>%
  select(Site, GenusSpecies, Year, SampleRound, State, Meadow) #don't need all the other info
syrph_n<-syrph%>%
  group_by(Site, Year,SampleRound)%>%
  count(GenusSpecies)%>%
filter(!(Site=="CC"))%>%# CC is just a non-site site
  mutate(SiteYear=paste0(Site, Year))%>%
   filter(!(SiteYear=="PL2017")) #veg data was messed up here, plus there was only one sample round before fire
syrph_all<-data.frame( plots = syrph_n$SiteYear, species =syrph_n$GenusSpecies,
                      freq = syrph_n$n, stringsAsFactors=FALSE)
mean_syrph<-crosstab(plots, species, freq, data=syrph_all, type="mean")#average species frequencies
syrph.dis<-dis.chao(mean_syrph, index="jaccard", version='prob') #I think the probability version was better than the rare one for some reason? 
syrph.dis<-as.matrix(syrph.dis) #there were no syrphs at UK, diagonal is all zeros which is good

```

### Now we want to calculate the community dissimilarity for the flowering communities. I originally did this with the bloom dataset, but now I am going to use the veg quadrat data instead, since it includes 2012. Going to be pulling the veg quadrat summary dataset straight from 4_specimenprep so I don't re-do work lol. 

```{r}
veg_quad<-read_csv("veg.bloom.quad.sp.csv")
mean_quad<-veg_quad%>%
  group_by(Site, Year, SampleRound, PlantGenusSpecies)%>%
  mutate(mean_abundance_per_quadrat=mean(FloweringPlantAbundance))
meadow.size<-spec.net%>%
  select(Site, Area)%>%
  unique()
mean_quad<-left_join(mean_quad, meadow.size, by="Site")
mean_quad<-mean_quad%>%
  group_by(Site, Year, PlantGenusSpecies)%>%
  mutate(mean_abundance_per_sampleR=mean(mean_abundance_per_quadrat))

scaled_abundance<-mean_quad%>%
  mutate(scaled_abundance=mean_abundance_per_sampleR*Area)

mean_quad<-mean_quad%>%
   mutate(SiteYear=paste0(Site, Year))%>%
  filter(!(SiteYear=="PL2017"))%>% #veg data was messed up here, plus there was only one sample round before fire
  select(SiteYear, PlantGenusSpecies, Year, mean_abundance_per_quadrat, SampleRound)

veg_all<-data.frame( plots = mean_quad$SiteYear, species =mean_quad$PlantGenusSpecies,
                      freq = mean_quad$mean_abundance_per_quadrat, sampleR=mean_quad$SampleRound, stringsAsFactors=FALSE)%>% #this takes the frequencies of each species at the quadrat level and makes it into a dataframe for 'crosstab'
  unique()
mean_veg<-crosstab(plots, species, freq, data=veg_all, type="mean")#average species frequencies across sample round, transpose so species are the columns and siteyears are the rows

veg.dis<-dis.chao(mean_veg, index="jaccard", version='prob') #calculates chao dissimilarity across the siteyears
veg.dis<-as.matrix(veg.dis)# looks good

##### need to make a separate matrix for syrphs since there were none for UK
mean_quad_syrph<-mean_quad%>%
   mutate(SiteYear=paste0(Site, Year))%>%
  filter(!(SiteYear=="PL2017"),!(SiteYear=="UK2017") )%>% #veg data was messed up here, plus there was only one sample round before fire
  select(SiteYear, PlantGenusSpecies, Year, mean_abundance_per_quadrat, SampleRound)
veg_syrph<-data.frame( plots = mean_quad_syrph$SiteYear, species = mean_quad_syrph$PlantGenusSpecies, freq = mean_quad_syrph$mean_abundance_per_quadrat, sampleR=mean_quad_syrph$SampleRound, stringsAsFactors=FALSE)%>% #this takes the frequencies of each species at the quadrat level and makes it into a dataframe for 'crosstab'
  unique()
mean_veg_syrph<-crosstab(plots, species, freq, data=veg_syrph, type="mean")#average species frequencies across sample round, transpose so species are the columns and siteyears are the rows

veg.dis.syrph<-dis.chao(mean_veg_syrph, index="jaccard", version='prob') #calculates chao dissimilarity across the siteyears

veg.dis.syrph<-as.matrix(veg.dis.syrph)#looks good

```
### we now want to calculate the geographic distances between sites
```{r}
lat_long<-sitestats%>%
  select(Long, Lat, Site)
```

